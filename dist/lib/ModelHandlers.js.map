{"version":3,"sources":["lib/ModelHandlers.ts"],"names":["ModelHandlers","ModelHandlers.constructor","ModelHandlers.documentReceived","ModelHandlers.creatingDocuments","ModelHandlers.savingDocument"],"mappings":"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","file":"lib/ModelHandlers.js","sourcesContent":["/// <reference path=\"../_references.d.ts\" />\r\nimport Core from './Core';\r\nimport {Schema} from './Schema';\r\nimport Model from './Model';\r\nimport ModelCache from './ModelCache';\r\nimport * as ModelOptions from './ModelOptions';\r\n\r\nimport _ = require('lodash');\r\nimport MongoDB = require('mongodb');\r\nimport Bluebird = require('bluebird');\r\n\r\nexport default class ModelHandlers<TDocument extends { _id?: any }, TInstance> {\r\n    constructor(public model: Model<TDocument, TInstance>) {\r\n\r\n    }\r\n\r\n    documentReceived<TResult>(conditions: any,\r\n        result: TDocument,\r\n        wrapper: (document: TDocument, isNew?: boolean, isPartial?: boolean) => TResult,\r\n        options: ModelOptions.QueryOptions = {}): Bluebird<TResult> {\r\n        _.defaults(options, {\r\n            cache: true,\r\n            partial: false\r\n        });\r\n\r\n        return Bluebird.resolve(result).then((target: any) => {\r\n            return <Bluebird<TResult>>Bluebird.resolve().then(() => {\r\n                // Trigger the received hook\r\n                if (this.model.hooks.onRetrieved) this.model.hooks.onRetrieved(target);\r\n\r\n                // Cache the document if caching is enabled\r\n                if (this.model.core.cache && options.cache && !options.fields) {\r\n                    this.model.cache.set(target); // Does not block execution pipeline - fire and forget\r\n                }\r\n\r\n                // Wrap the document and trigger the ready hook\r\n                var wrapped: TResult = wrapper(target, false, !!options.fields);\r\n\r\n                if (this.model.hooks.onReady && wrapped instanceof this.model.Instance) this.model.hooks.onReady(<TInstance><any>wrapped);\r\n                return wrapped;\r\n            });\r\n        });\r\n    }\r\n\r\n    creatingDocuments(documents: TDocument[]): Bluebird<any[]> {\r\n        return Bluebird.all(documents.map((document: any) => {\r\n            return Bluebird.resolve().then(() => {\r\n                if (this.model.hooks.onCreating) this.model.hooks.onCreating(document);\r\n                var validation: Skmatc.Result = this.model.helpers.validate(document);\r\n                if (validation.failed) return Bluebird.reject(validation.error);\r\n                return document;\r\n            });\r\n        }));\r\n    }\r\n\r\n    savingDocument(instance: TInstance, changes: any): Bluebird<TInstance> {\r\n        return Bluebird.resolve().then(() => {\r\n            if (this.model.hooks.onSaving) this.model.hooks.onSaving(instance, changes);\r\n            return instance;\r\n        });\r\n    }\r\n}\r\n"],"sourceRoot":"/source/"}